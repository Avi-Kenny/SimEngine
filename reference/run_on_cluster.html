<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Framework for running simulations on a cluster computing system — run_on_cluster • SimEngine</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Framework for running simulations on a cluster computing system — run_on_cluster"><meta name="description" content='This function allows for simulations to be run in parallel on a
    cluster computing system (CCS). See the Parallelization
    vignette for a detailed overview of how CCS parallelization works in
    SimEngine. run_on_cluster acts as a wrapper for the code in
    your simulation, organizing the code into three sections, labeled "first"
    (code that is run once at the start of the simulation), "main"
    (running the simulation script repeatedly), and "last" (code to process
    or summarize simulation results). This function is to be used in
    conjunction with job scheduler software (e.g., Slurm or Oracle Grid
    Engine) to divide the simulation into tasks that are run in parallel on
    the CCS. See the Parallelization documentation for a detailed overview of
    how CCS parallelization works in SimEngine.
    run)), and "last" (usually code to process or summarize
    simulation results). This function interacts with cluster job scheduler
    software (e.g. Slurm or Oracle Grid Engine) to divide parallel tasks over
    cluster nodes.'><meta property="og:description" content='This function allows for simulations to be run in parallel on a
    cluster computing system (CCS). See the Parallelization
    vignette for a detailed overview of how CCS parallelization works in
    SimEngine. run_on_cluster acts as a wrapper for the code in
    your simulation, organizing the code into three sections, labeled "first"
    (code that is run once at the start of the simulation), "main"
    (running the simulation script repeatedly), and "last" (code to process
    or summarize simulation results). This function is to be used in
    conjunction with job scheduler software (e.g., Slurm or Oracle Grid
    Engine) to divide the simulation into tasks that are run in parallel on
    the CCS. See the Parallelization documentation for a detailed overview of
    how CCS parallelization works in SimEngine.
    run)), and "last" (usually code to process or summarize
    simulation results). This function interacts with cluster job scheduler
    software (e.g. Slurm or Oracle Grid Engine) to divide parallel tasks over
    cluster nodes.'><meta property="og:image" content="https://avi-kenny.github.io/SimEngine/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SimEngine</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/SimEngine.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/advanced-functionality.html">Advanced functionality</a></li>
    <li><a class="dropdown-item" href="../articles/example_1.html">Example 1: Simulation-based power calculation</a></li>
    <li><a class="dropdown-item" href="../articles/example_2.html">Example 2: Comparing two standard error estimators</a></li>
    <li><a class="dropdown-item" href="../articles/parallelization.html">Parallelization</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Avi-Kenny/SimEngine/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Framework for running simulations on a cluster computing system</h1>
      <small class="dont-index">Source: <a href="https://github.com/Avi-Kenny/SimEngine/blob/master/R/run_on_cluster.R" class="external-link"><code>R/run_on_cluster.R</code></a></small>
      <div class="d-none name"><code>run_on_cluster.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function allows for simulations to be run in parallel on a
    cluster computing system (CCS). See the <a href="https://avi-kenny.github.io/SimEngine/articles/parallelization.html">Parallelization</a>
    vignette for a detailed overview of how CCS parallelization works in
    <span class="pkg">SimEngine</span>. <code>run_on_cluster</code> acts as a wrapper for the code in
    your simulation, organizing the code into three sections, labeled "first"
    (code that is run once at the start of the simulation), "main"
    (running the simulation script repeatedly), and "last" (code to process
    or summarize simulation results). This function is to be used in
    conjunction with job scheduler software (e.g., Slurm or Oracle Grid
    Engine) to divide the simulation into tasks that are run in parallel on
    the CCS. See the Parallelization documentation for a detailed overview of
    how CCS parallelization works in <span class="pkg">SimEngine</span>.
    <code><a href="run.html">run</a></code>)), and "last" (usually code to process or summarize
    simulation results). This function interacts with cluster job scheduler
    software (e.g. Slurm or Oracle Grid Engine) to divide parallel tasks over
    cluster nodes.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">run_on_cluster</span><span class="op">(</span><span class="va">first</span>, <span class="va">main</span>, <span class="va">last</span>, <span class="va">cluster_config</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-first">first<a class="anchor" aria-label="anchor" href="#arg-first"></a></dt>
<dd><p>Code to run at the start of a simulation. This should be a block
of code enclosed by curly braces  that creates and sets up a simulation
object.</p></dd>


<dt id="arg-main">main<a class="anchor" aria-label="anchor" href="#arg-main"></a></dt>
<dd><p>Code that will run for every simulation replicate. This should be
a block of code enclosed by curly braces , and will typically be a
single line of code calling the <code><a href="run.html">run</a></code>) function. This code
block will have access to the simulation object you created in the
'first' code block, but any changes made here to the simulation object
will not be saved.</p></dd>


<dt id="arg-last">last<a class="anchor" aria-label="anchor" href="#arg-last"></a></dt>
<dd><p>Code that will run after all simulation replicates have been run.
This should be a block of code enclosed by curly braces  that processes
your simulation object (which at this point will contain your results),
which may involve calls to <code><a href="summarize.html">summarize</a></code>, creation of plots,
and so on.</p></dd>


<dt id="arg-cluster-config">cluster_config<a class="anchor" aria-label="anchor" href="#arg-cluster-config"></a></dt>
<dd><p>A list of configuration options. You must specify
either <code>js</code> (the job scheduler you are using) or <code>tid_var</code> (the
name of the environment variable that your task ID is stored in); see
examples. Run <code><a href="js_support.html">js_support()</a></code> to see a list of job schedulers that
are currently supported. You can optionally also specify <code>dir</code>,
which is a character string representing a path to a directory on the
CCS; this directory will serve as your working directory and hold your
simulation object and all temporary objects created by <span class="pkg">SimEngine</span>.
If unspecified, this defaults to the working directory of the R script
that contains your simulation code).</p></dd>

</dl></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span>
<span><span class="co"># The following code is saved in a file called my_simulation.R:</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://avi-kenny.github.io/SimEngine/">SimEngine</a></span><span class="op">)</span></span>
<span><span class="fu">run_on_cluster</span><span class="op">(</span></span>
<span>  first <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="new_sim.html">new_sim</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">create_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">n</span>, lambda<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span>    <span class="va">est_lambda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"M"</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"V"</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="set_levels.html">set_levels</a></span><span class="op">(</span>estimator <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"M"</span>,<span class="st">"V"</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">100</span>,<span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="set_script.html">set_script</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">create_data</span><span class="op">(</span><span class="va">L</span><span class="op">$</span><span class="va">n</span><span class="op">)</span></span>
<span>      <span class="va">lambda_hat</span> <span class="op">&lt;-</span> <span class="fu">est_lambda</span><span class="op">(</span>dat<span class="op">=</span><span class="va">dat</span>, type<span class="op">=</span><span class="va">L</span><span class="op">$</span><span class="va">estimator</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"lambda_hat"</span><span class="op">=</span><span class="va">lambda_hat</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="set_config.html">set_config</a></span><span class="op">(</span>num_sim<span class="op">=</span><span class="fl">100</span>, n_cores<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  main <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="run.html">run</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  last <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="summarize.html">summarize</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  cluster_config <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>js<span class="op">=</span><span class="st">"slurm"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The following code is saved in a file called run_sim.sh:</span></span>
<span><span class="co"># #!/bin/bash</span></span>
<span><span class="co"># Rscript my_simulation.R</span></span>
<span></span>
<span><span class="co"># The following lines of code are run on the CCS head node:</span></span>
<span><span class="co"># sbatch --export=sim_run='first' run_sim.sh</span></span>
<span><span class="co"># sbatch --export=sim_run='main' --array=1-20 --depend=afterok:101 run_sim.sh</span></span>
<span><span class="co"># sbatch --export=sim_run='last' --depend=afterok:102 run_sim.sh</span></span>
<span><span class="op">}</span> <span class="co"># }</span></span></code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Avi Kenny, Charles Wolock.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

