---
title: "simba: Getting started"
output: rmarkdown::word_document
vignette: >
  %\VignetteIndexEntry{getting-started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse=TRUE, comment="#>")
```

# Overview

`Simba` is a package for structuring, maintaining, and running statistical simulations.

Here is a simple example that illustrates the basic workflow:

```{r}

library(simba)
library(magrittr) # !!!!! Finish NAMESSPACES chapter and get rid of this
library(parallel) # !!!!! Finish NAMESSPACES chapter and get rid of this

sim <- new_sim()

sim %<>% set_config(
  num_sim = 5,
  parallel = "none",
  packages = c("magrittr", "dplyr")
)

sim %<>% set_levels(
  "sample_size" = c(10, 100, 1000),
  "lambda" = c(5, 10), # !!!!! testing
  "methods_grp_1" = c("sample_var", "sample_mean")
)

sim %<>% add_constants(
  "lambda2" = 4, # !!!!! testing
  "lambda3" = 6 # !!!!! testing
)

sim %<>% add_creator(
  "create_poisson_data",
  function(n, lambda) {
    x <- rpois(n=n, lambda=lambda)
    return (x)
  }
)

sim %<>% add_method(
  "sample_mean",
  function(x) {
    return ( mean(x) )
  }
)

sim %<>% add_method(
  "sample_var",
  function(x) {
    return ( var(x) )
  }
)

sim %<>% add_script(
  "script_1",
  function(L,C) { # !!!!! Consider not making this a function of L and just relying on this being run in a specific environment
    
    data <- create_poisson_data(L$sample_size, L$lambda)
    # data <- create_poisson_data(L$sample_size, C$lambda)
    
    lambda_hat <- use_method(L$methods_grp_1, data)
    
    time <- Sys.time()
    
    # `results` should be a list of key-value pairs
    # !!!!! Throw warning if any column names are duplicated/overwritten
    return (list(
      "lambda_hat" = lambda_hat,
      "time" = time
    ))

  }
)

# Print simulation object
print(sim)

# Run simulation
sim %<>% run("script_1")

# Summarize results (with standard deviations)
# !!!!! Throw warning if any column names are duplicated/overwritten
# Make it such that you can't use expressions like `truth=C$lambda` here (i.e. 
#     you can't pass constants); instead, add constants to results data frame
#     and reference by quotes like the others; alternatively
summary(
  sim,
  sd = list(name="sd_lambda", x="lambda_hat"),
  bias = list(name="bias_lambda", truth="lambda", estimate="lambda_hat")
)

# !!!!! Add coverage; see z.stepped_wedge
# summary(
#   results,
#   sd = TRUE,
#   coverage = list(name="theta", truth=L$theta, estimate=R$theta_hat, se=R$se_theta_hat)
#   # coverage = list(
#   #   list(name="theta", truth=L$theta, estimate=R$theta_hat, se=R$se_theta_hat),
#   #   list(name="d", truth=L$d, estimate=R$d_hat, se=R$se_d_hat)
#   # )
# )

```

Above, by convention, we use the pipe operators (`%>%` and `%<>%`) from the `magrittr` package; if you are unfamiliar with the pipe operator, check out the [magrittr documentation](https://magrittr.tidyverse.org/). In general, we will always use the compound pipe (`%<>%`) except for when we run the simulation with `sim %>% run()`, which uses the regular pipe (`%>%`).

# Using previously-defined functions

Above, we created new functions and named them "create_rct" and "OLS". It's also easy to use previously-defined functions. You can give the functions a new name, or use the name of the function.

```{r}

create_data <- function(n, sigma) {
  x <- runif(n)
  y <- 4*x + rnorm(n, mean=0, sd=sigma)
  return (data.frame(x=x,y=y))
}

ols <-   function(data) {
  model <- lm(y~x, data=data)
  return (model$coefficients[["x"]])
}

sim %<>% add_creator(create_data)
sim %<>% add_method(ols)

```
