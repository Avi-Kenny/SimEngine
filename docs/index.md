---
layout: default
title: Home
nav_order: 1
description: "simba: an open-source framework for statistical simulations in R"
permalink: /
last_modified_date: 2020-04-27T17:54:08+0000
---

<img src="assets/images/logo.png" align="right" alt="simba" style="height:150px">

# simba
{: .fs-9 }

An open-source framework for statistical simulations in R
{: .fs-5 .fw-300 }

<a href="https://github.com/Avi-Kenny/simba" target="_blank">View source code on GitHub</a>{: .btn .btn-primary .fs-4 .mb-4 .mb-md-0 .mr-2 }

---

## Overview

**simba** is an open-source R package for structuring, maintaining, running, and debugging statistical simulations. Emphasis is placed on ease of use, clear documentation, speed, and scalability.

## Installation

**simba** is currently hosted on GitHub and can be easily installed using the **devtools** package.

```R
library(devtools)
install_github(repo="Avi-Kenny/simba")
```

## Getting started

The goal of a statistical simulation is often to test how a new statistical method performs against existing methods. Most statistical simulations include three basic phases: (1) generate some data, (2) run one or more methods using the generated data, and (3) compare the performance of the methods. We highly recommend reading the <a href="/docs/concepts.html" target="_blank">Simulation concepts</a> section of this site for further discussion of these phases and other high-level concepts related to designing and running simulations with **simba**.

To briefly illustrate how these phases are implemented using **simba**, we will use the example of estimating the average treatment effect of a drug in the context of a randomized controlled trial (RCT).

### 1) Load the package and create a "simulation object"
The simulation object (an R object of class *simba*) will contain all data, functions, and results related to your simulation. Note that we make extensive use of the pipe operators (%<>% and %>%) from the **magrittr** package; if you have never used pipe operators, check out the <a href="https://magrittr.tidyverse.org" target="_blank">magrittr documentation</a>].

```R
library(simba)
library(magrittr)
sim <- new_sim()
```

### 2) Write a function to generate some data
In **simba**, functions that generate data are called *creators*. Our creator will simulate data from an RCT in which we compare a continuous outcome (blood pressure) between two groups (the "treatment group" versus the "control group"). We generate the data by looping through individuals, assigning them randomly to either the treatment group or the control group, and generating their outcome according to a simple model (note: although we use a for-loop for illustrative purposes, vectorized methods are often faster).

```R
create_rct_data <- function (num_patients) {
  df <- data.frame(
    "patient_id" = integer(),
    "group" = character(),
    "outcome" = double(),
    stringsAsFactors = FALSE
  )
  for (i in 1:num_patients) {
    group <- ifelse(sample(c(0,1), size=1)==1, "treatment", "control")
    treatment_effect <- ifelse(group=="treatment", -7, 0)
    outcome <- rnorm(n=1, mean=130, sd=5) + treatment_effect
    df[i,] <- list(i, group, outcome)
  }
  return (df)
}

# Test our creator function
create_rct_data(5)
#>   patient_id     group  outcome
#> 1          1 treatment 140.6040
#> 2          2 treatment 125.9386
#> 3          3   control 106.2271
#> 4          4 treatment 131.7250
#> 5          5   control 129.4923
```

Once you have declared your creator function, add it to your simulation object using the *add_creator()* function.

```R
sim %<>% add_creator(create_rct_data)
```

### 3) Code your methods
In this example, we test two different estimators of the average treatment effect. The first estimator uses the known probability of being assigned to the treatment group (0.5), whereas the second estimator uses an estimate of this probability based on the observed data. Don't worry too much about the mathematical deatils; the important thing is that both methods attempt to take in the dataset generated by the *create_rct_data()* function and return an estimate of the true treatment effect, which in this case is *-7*.

```R
estimator_1 <- function(df) {
  n <- nrow(df)
  true_prob <- 0.5
  sum_t <- sum(df$outcome * (df$group=="treatment"))
  sum_c <- sum(df$outcome * (df$group=="control"))
  return ( sum_t/(n*true_prob) - sum_c/(n*(1-true_prob)) )
}
estimator_2 <- function(df) {
  n <- nrow(df)
  est_prob <- sum(df$group=="treatment") / n
  sum_t <- sum(df$outcome * (df$group=="treatment"))
  sum_c <- sum(df$outcome * (df$group=="control"))
  return ( sum_t/(n*est_prob) - sum_c/(n*(1-est_prob)) )
}

# Test our estimator functions
df <- create_rct_data(10000)
estimator_1(df)
#> [1] -7.291477
estimator_2(df)
#> [1] -7.038604
```

Next, add the methods to your simulation object using the *add_method()* function.

```R
sim %<>% add_method(estimator_1)
sim %<>% add_method(estimator_2)
```

### 4) Set the simulation levels
Often, we want to run the same simulation multiple times (with each run referred to as a "simulation replicate"), but with certain things changed. In this example, perhaps we want to vary the number of patients and the method used to estimate the average treatment effect. We refer to the things that vary as "simulation levels". By default, **simba** will run our simulation 1,000 times for each level combination. Below, since there are two methods and three values of num_patients, we have six level combinations and so **simba** will run a total of 6,000 simulation replicates.

```R
sim %<>% set_levels(
  estimator = c("estimator_1", "estimator_2"),
  num_patients = c(50, 200, 1000)
)
```

### 5) Create a simulation script
The script is a function that contains the set of instructions for running a single simulation replicate. Within a script, you have access to several special functions and variables:
- We can reference the current simulation level values using the variable *L*. For example, when the first simulation replicate is running, *L$method* will equal "estimator_1" and *L$num_patients* will equal 50. In the last simulation replicate, *L$method* will equal "estimator_2" and *L$num_patients* will equal 1,000.
- We can use the methods we defined earlier either by calling the functions directly or by using the *use_method()* function (as is illustrated below). The latter is useful when your method is a simulation level, which will often be the case. The *use_method()* function is conceptually simular to *do.call()* from base R; the first argument is the name of your method (as a character string) and the remaining arguments are passed to the method.
- We can also reference <a href="" target="_blank">simulation constants</a> and use the special <a href="" target="_blank">*use_creator()*</a> function, which is similar to *use_method()*.

```R
sim %<>% add_script(
  "my script",
  function() {
    df <- create_rct_data(L$num_patients)
    estimate <- use_method(L$estimator, df)
    return (
      list("estimate" = estimate)
    )
  }
)
```

Your script should always return a named list, although your list can be complex and contain dataframes, multiple levels of nesting, etc.

### 6) Set the simulation configuration
This controls options related to your entire simulation, such as the number of simulation replicates to run for each level combination and how to <a href="/docs/parallel.html" target="_blank">parallelize</a> your code. This is discussed in detail on the <a href="/docs/configuration.html" target="_blank">Configuration</a> page.

```R
sim %<>% set_config(
  num_sim = 1000,
  parallel = "none"
)
```

### 7) Run the simulation
All 6,000 replicates are run at once and results are stored in the simulation object itself.

```R
sim %<>% run("my script")
```

### 8) Summarize results
TO DO

---

## About this project

simba was created and is maintained by <a href="https://github.com/Avi-Kenny" target="_blank">Avi Kenny</a>. The package is licensed using the <a href="https://github.com/Avi-Kenny/simba/blob/master/LICENSE.txt" target="_blank">GNU General Public Licence (GPL) V3</a>.


<!--

!!!!! ARCHIVE !!!!!

We recommend the compact syntax above, but it sometimes may be useful to create a function and add it to your simulation object afterwards.

```R
my_function <- function (n_patients) {...}
sim %<>% add_creator("create_rct_data", my_function)
```

For simple simulations, you will often write creators that return dataframes, but you can return more complex objects, such as a list of multiple dataframes, a network data structure, etc.

-->
