---
layout: default
title: Home
nav_order: 1
permalink: /
---

<img src="assets/images/logo.png" align="right" alt="SimEngine" style="height:150px">

# SimEngine
{: .fs-9 .fw-500 }

A modular framework for statistical simulations in R
{: .fs-5 }

<a href="https://github.com/Avi-Kenny/SimEngine">View source code on GitHub</a>{: .btn .btn-primary .fs-4 .mt-1 }

---

## Overview

**SimEngine** is an open-source R package for structuring, maintaining, running, and debugging statistical simulations on both local and cluster-based computing environments. Emphasis is placed on thorough documentation and scalability.

## Installation

The latest stable version of **SimEngine** can be installed from CRAN using `install.packages()`. The current development version can be installed using `devtools::install_github()`:

```R
install.packages("SimEngine")
devtools::install_github(repo="Avi-Kenny/SimEngine")
```

## Getting started

The goal of many statistical simulations is to test how a new statistical method performs against existing methods. Most statistical simulations include three basic phases: (1) generate some data, (2) run one or more methods using the generated data, and (3) compare the performance of the methods. 

To briefly illustrate how these phases are implemented using **SimEngine**, we will use the example of estimating the average treatment effect of a drug in the context of a randomized controlled trial (RCT).

### 1) Load the package and create a "simulation object"

The simulation object (an R object of class *SimEngine*) will contain all data, functions, and results related to your simulation.

```R
library(SimEngine)
sim <- new_sim()
```

### 2) Code a function to generate some data

Most simulations will involve one or more functions that create a dataset designed to mimic some real-world data structure. Here, we write a function that simulates data from an RCT in which we compare a continuous outcome (e.g. blood pressure) between a treatment group and a control group. We generate the data by looping through a set of patients, assigning them randomly to one of the two groups, and generating their outcome according to a simple model.

```R
# Code up the dataset-generating function
create_rct_data <- function (num_patients) {
  df <- data.frame(
    "patient_id" = integer(),
    "group" = character(),
    "outcome" = double(),
    stringsAsFactors = FALSE
  )
  for (i in 1:num_patients) {
    group <- ifelse(sample(c(0,1), size=1)==1, "treatment", "control")
    treatment_effect <- ifelse(group=="treatment", -7, 0)
    outcome <- rnorm(n=1, mean=130, sd=5) + treatment_effect
    df[i,] <- list(i, group, outcome)
  }
  return (df)
}

# Test the function
create_rct_data(5)
#>   patient_id     group  outcome
#> 1          1 treatment 140.6040
#> 2          2 treatment 125.9386
#> 3          3   control 106.2271
#> 4          4 treatment 131.7250
#> 5          5   control 129.4923
```

### 3) Code your methods (or other functions)

With **SimEngine**, any functions that you declare (or load via `source()`) are automatically added to your simulation object when the simulation runs. In this example, we test two different estimators of the average treatment effect. For simplicity, we code this as a single function and use the `type` argument to specify which estimator we want to use, but you could also write two separate functions. The first estimator uses the known probability of being assigned to the treatment group (0.5), whereas the second estimator uses an estimate of this probability based on the observed data. Don't worry too much about the mathematical details; the important thing is that both methods attempt to take in the dataset generated by the `create_rct_data()` function and return an estimate of the treatment effect, which in this case is *-7*.

```R
# Code up the estimators
est_tx_effect <- function(df, type) {
  n <- nrow(df)
  sum_t <- sum(df$outcome * (df$group=="treatment"))
  sum_c <- sum(df$outcome * (df$group=="control"))
  if (type=="est1") {
    true_prob <- 0.5
    return ( sum_t/(n*true_prob) - sum_c/(n*(1-true_prob)) )
  } else if (type=="est2") {
    est_prob <- sum(df$group=="treatment") / n
    return ( sum_t/(n*est_prob) - sum_c/(n*(1-est_prob)) )
  }
}

# Test out the estimators
df <- create_rct_data(10000)
est_tx_effect(df, "est1")
#> [1] -7.291477
est_tx_effect(df, "est2")
#> [1] -7.038604
```

### 4) Set the simulation levels

Often, we want to run the same simulation multiple times (with each run referred to as a "simulation replicate"), but with certain things changed. In this example, perhaps we want to vary the number of patients and the method used to estimate the average treatment effect. We refer to the things that vary as "simulation levels". By default, **SimEngine** will run our simulation 10 times for each level combination. Below, since there are two methods and three values of num_patients, we have six level combinations and so **SimEngine** will run a total of 60 simulation replicates. Note that we make extensive use of the pipe operators (`%>%` and `%<>%`) from the **magrittr** package; if you have never used pipes, check out the <a href="https://magrittr.tidyverse.org">magrittr documentation</a>.

```R
sim %<>% set_levels(
  estimator = c("est1", "est2"),
  num_patients = c(50, 200, 1000)
)
```

### 5) Create a simulation script

The simulation script is a function that runs a single simulation replicate and returns the results. Within a script, you can reference the current simulation level values using the variable *L*. For example, when the first simulation replicate is running, `L$estimator` will equal "est1" and `L$num_patients` will equal 50. In the last simulation replicate, `L$estimator` will equal "est2" and `L$num_patients` will equal 1,000. Your script will automatically have access to any functions that you created earlier.

```R
sim %<>% set_script(function() {
  df <- create_rct_data(L$num_patients)
  est <- est_tx_effect(df, L$estimator)
  return (list("est"=est))
})
```

Your script should always return a named list, although your list can be complex and contain dataframes, multiple levels of nesting, etc. Note that you can also code your estimators as separate functions and call them from within the script using <a href="/function-reference/use_method">`use_method`</a>.

### 6) Set the simulation configuration

This controls options related to your entire simulation, such as the number of simulation replicates to run for each level combination and how to <a href="/parallelization">parallelize</a> your code. This is also where you should specify any packages your simulation needs (instead of using `library()` or `require()`). This is discussed in detail on the <a href="/function-reference/set_config">`set_config`</a> page. We set `num_sim` to 10, and so **SimEngine** will run a total of 60 simulation replicates (10 for each level combination).

```R
sim %<>% set_config(
  num_sim = 10,
  parallel = "outer",
  n_cores = 2,
  packages = c("ggplot2", "stringr")
)
```

### 7) Run the simulation

All 600 replicates are run at once and results are stored in the simulation object.

```R
sim %<>% run()
#> "Done. No errors detected."
```

### 8) View and summarize results

Once the simulations have finished, use the `summarize()` function to calculate common summary statistics, such as bias, variance, MSE, and coverage.

```R
sim %>% summarize(
  bias = list(truth=-7, estimate="est"),
  mse = list(truth=-7, estimate="est")
)
#>   level_id estimator num_patients    bias_est      MSE_est
#> 1        1     est_1           50  2.91313267 1221.3380496
#> 2        2     est_2           50 -0.11626316    1.9830060
#> 3        3     est_1          100 -5.55941452  614.2357481
#> 4        4     est_2          100 -0.05772176    0.9293629
#> 5        5     est_1          200  0.22825547  376.3410262
#> 6        6     est_2          200  0.20431877    0.5332393
```

In this example, we see that the MSE of estimator 1 is much higher than that of estimator 2 and that MSE decreases with increasing sample size for both estimators, as expected.

You can also directly access the results for individual simulation replicates.

```R
head(sim$results)
#>   sim_uid level_id rep_id estimator num_patients     runtime        est
#> 1       1        1      1     est_1           50 0.007977009 -47.961709
#> 2       2        1      2     est_1           50 0.010969162  23.805217
#> 3       3        1      3     est_1           50 0.006983995  -8.066438
#> 4       4        1      4     est_1           50 0.004987001 -15.221781
#> 5       5        1      5     est_1           50 0.003988981   2.726603
#> 6       6        1      6     est_1           50 0.010968924  13.232685
```

---

## About this project

**SimEngine** was created by <a href="https://github.com/Avi-Kenny">Avi Kenny</a> and <a href="https://github.com/cwolock">Charles Wolock</a>. The package is licensed using the <a href="https://github.com/Avi-Kenny/SimEngine/blob/master/LICENSE.txt">GNU General Public Licence (GPL) V3</a>.
