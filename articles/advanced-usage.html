<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SimEngine">
<title>Advanced usage • SimEngine</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Advanced usage">
<meta property="og:description" content="SimEngine">
<meta property="og:image" content="https://avi-kenny.github.io/SimEngine/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SimEngine</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/SimEngine.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/advanced-usage.html">Advanced usage</a>
    <a class="dropdown-item" href="../articles/example_1.html">Example 1: Simulation-based power calculation</a>
    <a class="dropdown-item" href="../articles/example_2.html">Example 2: Comparing two standard error estimators</a>
    <a class="dropdown-item" href="../articles/parallelization.html">Parallelization</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Avi-Kenny/SimEngine/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Advanced usage</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Avi-Kenny/SimEngine/blob/HEAD/vignettes/advanced-usage.Rmd" class="external-link"><code>vignettes/advanced-usage.Rmd</code></a></small>
      <div class="d-none name"><code>advanced-usage.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="complex-simulation-levels">Complex simulation levels<a class="anchor" aria-label="anchor" href="#complex-simulation-levels"></a>
</h2>
<p>Often, simulation levels will be simple, such as a vector of sample
sizes:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_sim.html">new_sim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_levels.html">set_levels</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">200</span>,<span class="fl">400</span>,<span class="fl">800</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>However, there will be many instances in which more complex objects
are needed. For these cases, instead of a vector of numbers or character
strings, use a <em>named</em> list of lists. The toy example below
illustrates this. Note that the list names (<code>"Beta 1"</code>,
<code>"Beta 2"</code>, and <code>"Normal"</code>) become the entries in
the <code>sim$results</code> dataframe.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_sim.html">new_sim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_levels.html">set_levels</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">100</span><span class="op">)</span>,</span>
<span>  distribution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Beta 1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"Beta"</span>, params<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"Beta 2"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"Beta"</span>, params<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"Normal"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"Normal"</span>, params<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.0</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">create_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">type</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"Beta"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n</span>, shape1<span class="op">=</span><span class="va">params</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, shape2<span class="op">=</span><span class="va">params</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"Normal"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean<span class="op">=</span><span class="va">params</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, sd<span class="op">=</span><span class="va">params</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_script.html">set_script</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">create_data</span><span class="op">(</span><span class="va">L</span><span class="op">$</span><span class="va">n</span>, <span class="va">L</span><span class="op">$</span><span class="va">distribution</span><span class="op">$</span><span class="va">type</span>, <span class="va">L</span><span class="op">$</span><span class="va">distribution</span><span class="op">$</span><span class="va">params</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"y"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Done. No errors or warnings detected.</span></span>
<span><span class="va">sim</span><span class="op">$</span><span class="va">results</span></span>
<span><span class="co">#&gt;   sim_uid level_id rep_id   n distribution      runtime         y</span></span>
<span><span class="co">#&gt; 1       1        1      1  10       Beta 1 0.0007205009 0.4023045</span></span>
<span><span class="co">#&gt; 2       2        2      1 100       Beta 1 0.0042247772 0.3278219</span></span>
<span><span class="co">#&gt; 3       3        3      1  10       Beta 2 0.0003337860 0.7269913</span></span>
<span><span class="co">#&gt; 4       4        4      1 100       Beta 2 0.0003042221 0.8021276</span></span>
<span><span class="co">#&gt; 5       5        5      1  10       Normal 0.0002956390 3.0143173</span></span>
<span><span class="co">#&gt; 6       6        6      1 100       Normal 0.0002839565 3.0185205</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="complex-return-data">Complex return data<a class="anchor" aria-label="anchor" href="#complex-return-data"></a>
</h2>
<p>In most situations, the results of simulations will be numeric.
However, we may want to return more complex data, such as matrices,
lists, or model objects. To do this, we include our complex return data
in the list with the special key <code>".complex"</code>. This is
illustrated in the toy example below, in which we estimate the
parameters of a linear regression and returns these as numeric, but also
return the estimated covariance matrix and the entire model object.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_sim.html">new_sim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_levels.html">set_levels</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">create_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">3</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">=</span><span class="va">x</span>, <span class="st">"y"</span><span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_config.html">set_config</a></span><span class="op">(</span>num_sim<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_script.html">set_script</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">create_data</span><span class="op">(</span><span class="va">L</span><span class="op">$</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span>, data<span class="op">=</span><span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"beta0_hat"</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="st">"beta1_hat"</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="st">".complex"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="st">"model"</span> <span class="op">=</span> <span class="va">model</span>,</span>
<span>      <span class="st">"cov_mtx"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Done. No errors or warnings detected.</span></span></code></pre></div>
<p>After running this simulation, we can examine the numeric results
directly by accessing <code>sim$results</code> or using the
<code>summarize</code> function, as usual:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span><span class="op">$</span><span class="va">results</span></span>
<span><span class="co">#&gt;   sim_uid level_id rep_id    n     runtime beta0_hat beta1_hat</span></span>
<span><span class="co">#&gt; 1       1        1      1   10 0.003581285  3.921553 0.2882536</span></span>
<span><span class="co">#&gt; 2       4        1      2   10 0.001084089  3.020516 2.9252349</span></span>
<span><span class="co">#&gt; 3       2        2      1  100 0.004177809  3.046730 1.7472417</span></span>
<span><span class="co">#&gt; 4       5        2      2  100 0.001058578  3.195638 1.6732540</span></span>
<span><span class="co">#&gt; 5       3        3      1 1000 0.001397371  2.979008 1.9998622</span></span>
<span><span class="co">#&gt; 6       6        3      2 1000 0.001241207  2.988982 2.0412561</span></span></code></pre></div>
<p>However, we may also want to look at the complex return data. To do
so, we use the special function <code>get_complex</code>, as illustrated
below:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_complex.html">get_complex</a></span><span class="op">(</span><span class="va">sim</span>, sim_uid<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">c5</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ x, data = dat)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -2.3958 -0.6824 -0.1134  0.7840  1.8194 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   3.1956     0.1891  16.898  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; x             1.6733     0.3185   5.254 8.68e-07 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 1.02 on 98 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.2198, Adjusted R-squared:  0.2118 </span></span>
<span><span class="co">#&gt; F-statistic: 27.61 on 1 and 98 DF,  p-value: 8.676e-07</span></span>
<span><span class="va">c5</span><span class="op">$</span><span class="va">cov_mtx</span></span>
<span><span class="co">#&gt;             (Intercept)           x</span></span>
<span><span class="co">#&gt; (Intercept)  0.03576567 -0.05071009</span></span>
<span><span class="co">#&gt; x           -0.05071009  0.10141526</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-the-batch-function">Using the <code>batch</code> function<a class="anchor" aria-label="anchor" href="#using-the-batch-function"></a>
</h2>
<p>The <code>batch</code> function is useful if you want to share data
or objects between simulation replicates. Essentially, it allows you to
take your simulation replicates and divide them into “batches”; all
replicates in a given batch will then share a single set of objects. The
most common use case for this is if you have a simulation that involves
generating one dataset, analyzing it using multiple methods, and then
repeating this a number of times. To illustrate the use of
<code>batch</code> using this example, first consider the following
simulation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_sim.html">new_sim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">create_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">n</span>, mean<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="va">est_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"est_mean"</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"est_median"</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_levels.html">set_levels</a></span><span class="op">(</span>est<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_mean"</span>,<span class="st">"est_median"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_config.html">set_config</a></span><span class="op">(</span>num_sim<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_script.html">set_script</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">create_data</span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">mu_hat</span> <span class="op">&lt;-</span> <span class="fu">est_mean</span><span class="op">(</span>dat<span class="op">=</span><span class="va">dat</span>, type<span class="op">=</span><span class="va">L</span><span class="op">$</span><span class="va">est</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"mu_hat"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">mu_hat</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="st">"dat_1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Done. No errors or warnings detected.</span></span></code></pre></div>
<p>If we look at the “dat_1” column of the results object (equal to the
first element of the <code>dat</code> vector created in the simulation
script), we see that a unique dataset was created for each simulation
replicate:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span><span class="op">$</span><span class="va">results</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">results</span><span class="op">$</span><span class="va">rep_id</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;   sim_uid level_id rep_id        est      runtime mu_hat dat_1</span></span>
<span><span class="co">#&gt; 1       1        1      1   est_mean 0.0003657341   3.08  4.49</span></span>
<span><span class="co">#&gt; 4       2        2      1 est_median 0.0040476322   3.10  4.25</span></span>
<span><span class="co">#&gt; 2       3        1      2   est_mean 0.0003488064   2.91  3.51</span></span>
<span><span class="co">#&gt; 5       5        2      2 est_median 0.0003473759   2.88  3.35</span></span>
<span><span class="co">#&gt; 3       4        1      3   est_mean 0.0003185272   2.97  1.84</span></span>
<span><span class="co">#&gt; 6       6        2      3 est_median 0.0003337860   3.15  5.74</span></span></code></pre></div>
<p>Suppose that instead, we want to run a simulation where we generate
one dataset, analyzing it using multiple methods (in this case
corresponding to “est_mean” and “est_median”), and then repeating this
twice. We can do this using the <code>batch</code> function, as
follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_sim.html">new_sim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">create_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">n</span>, mean<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="va">est_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"est_mean"</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"est_median"</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_levels.html">set_levels</a></span><span class="op">(</span>est<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_mean"</span>,<span class="st">"est_median"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_config.html">set_config</a></span><span class="op">(</span>num_sim<span class="op">=</span><span class="fl">3</span>, batch_levels<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_script.html">set_script</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/batch.html">batch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">create_data</span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">mu_hat</span> <span class="op">&lt;-</span> <span class="fu">est_mean</span><span class="op">(</span>dat<span class="op">=</span><span class="va">dat</span>, type<span class="op">=</span><span class="va">L</span><span class="op">$</span><span class="va">est</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"mu_hat"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">mu_hat</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="st">"dat_1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Done. No errors or warnings detected.</span></span></code></pre></div>
<p>In the code above, we changed two things. One, we added
<code>batch_levels=NULL</code> to the <code>set_config</code> call;
don’t worry about this for now. Second, we wrapped the code line
<code>dat &lt;- create_data(n=100)</code> inside the <code>batch</code>
function. Whatever code goes inside the <code>batch</code> function will
produce the same output for all simulations in a batch; in this case, if
we look at the “dat_1” column of the results object, we can see that one
dataset was created and shared by the batch corresponding to sim_uids 1
and 2:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span><span class="op">$</span><span class="va">results</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">results</span><span class="op">$</span><span class="va">rep_id</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;   sim_uid level_id rep_id        est      runtime mu_hat dat_1</span></span>
<span><span class="co">#&gt; 1       1        1      1   est_mean 0.0006241798   2.82  2.81</span></span>
<span><span class="co">#&gt; 4       2        2      1 est_median 0.0062849522   2.91  2.81</span></span>
<span><span class="co">#&gt; 2       3        1      2   est_mean 0.0013184547   2.95  2.24</span></span>
<span><span class="co">#&gt; 5       5        2      2 est_median 0.0004265308   2.91  2.24</span></span>
<span><span class="co">#&gt; 3       4        1      3   est_mean 0.0004475117   3.08  1.82</span></span>
<span><span class="co">#&gt; 6       6        2      3 est_median 0.0004236698   3.10  1.82</span></span></code></pre></div>
<p>However, the situation is often more complicated. What if we have a
simulation with multiple level variables, some that correspond to
creating data and some that correspond to analyzing the data? This is
where the <code>batch_levels</code> config option comes in. It is easy
to use; simply specify the names of the level variables that are used
<em>within</em> the batch function. Here is an example:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_sim.html">new_sim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">create_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">mu</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">n</span>, mean<span class="op">=</span><span class="va">mu</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="va">est_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"est_mean"</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"est_median"</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_levels.html">set_levels</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">100</span><span class="op">)</span>, mu<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">5</span><span class="op">)</span>, est<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"est_mean"</span>,<span class="st">"est_median"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_config.html">set_config</a></span><span class="op">(</span>num_sim<span class="op">=</span><span class="fl">2</span>, batch_levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="st">"mu"</span><span class="op">)</span>, return_batch_id<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_script.html">set_script</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/batch.html">batch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">create_data</span><span class="op">(</span>n<span class="op">=</span><span class="va">L</span><span class="op">$</span><span class="va">n</span>, mu<span class="op">=</span><span class="va">L</span><span class="op">$</span><span class="va">mu</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">mu_hat</span> <span class="op">&lt;-</span> <span class="fu">est_mean</span><span class="op">(</span>dat<span class="op">=</span><span class="va">dat</span>, type<span class="op">=</span><span class="va">L</span><span class="op">$</span><span class="va">est</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"mu_hat"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">mu_hat</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="st">"dat_1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Done. No errors or warnings detected.</span></span>
<span></span>
<span><span class="va">sim</span><span class="op">$</span><span class="va">results</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">results</span><span class="op">$</span><span class="va">batch_id</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;    sim_uid level_id rep_id batch_id   n mu        est      runtime mu_hat dat_1</span></span>
<span><span class="co">#&gt; 1        1        1      1        1  10  3   est_mean 0.0005402565   3.40  4.85</span></span>
<span><span class="co">#&gt; 9        5        5      1        1  10  3 est_median 0.0004427433   3.37  4.85</span></span>
<span><span class="co">#&gt; 2        9        1      2        2  10  3   est_mean 0.0004169941   3.04  2.13</span></span>
<span><span class="co">#&gt; 10      13        5      2        2  10  3 est_median 0.0034101009   2.89  2.13</span></span>
<span><span class="co">#&gt; 3        2        2      1        3 100  3   est_mean 0.0041105747   2.91  3.69</span></span>
<span><span class="co">#&gt; 11       6        6      1        3 100  3 est_median 0.0004205704   2.84  3.69</span></span>
<span><span class="co">#&gt; 4       10        2      2        4 100  3   est_mean 0.0004200935   2.86  2.66</span></span>
<span><span class="co">#&gt; 12      14        6      2        4 100  3 est_median 0.0004482269   2.81  2.66</span></span>
<span><span class="co">#&gt; 5        3        3      1        5  10  5   est_mean 0.0004637241   4.89  3.94</span></span>
<span><span class="co">#&gt; 13       7        7      1        5  10  5 est_median 0.0004172325   5.11  3.94</span></span>
<span><span class="co">#&gt; 6       11        3      2        6  10  5   est_mean 0.0004267693   5.34  5.67</span></span>
<span><span class="co">#&gt; 14      15        7      2        6  10  5 est_median 0.0004112720   5.39  5.67</span></span>
<span><span class="co">#&gt; 7        4        4      1        7 100  5   est_mean 0.0004315376   5.12  5.29</span></span>
<span><span class="co">#&gt; 15       8        8      1        7 100  5 est_median 0.0004093647   5.02  5.29</span></span>
<span><span class="co">#&gt; 8       12        4      2        8 100  5   est_mean 0.0004134178   5.09  6.68</span></span>
<span><span class="co">#&gt; 16      16        8      2        8 100  5 est_median 0.0004084110   5.00  6.68</span></span></code></pre></div>
<p>We see that we have achieved what we wanted - the batches were
created such that each batch contained two replicates, one for each
estimator. We also specified the <code>return_batch_id=T</code> option
in <code>set_config</code> so that the results object would return the
<code>batch_id</code>. The <code>batch_id</code> is the variable that
defines the batches; all simulations that share the same batch_id. It
can be useful to use this option to ensure that you are using the
<code>batch</code> function correctly.</p>
<p>Here are a few tips to keep in mind when using the batch
function:</p>
<ol style="list-style-type: decimal">
<li>The code within the <code>batch</code> code block should
<em>only</em> create objects; do not attempt to change or delete
existing objects, as these changes may be ignored.</li>
<li>In the majority of cases, the <code>batch</code> function will be
called just once, at the top of the simulation script. However, it can
be used anywhere in the script and can be called multiple times. Never
use <code>batch</code> outside of the simulation script.</li>
<li>Although we illustrated the use of the <code>batch</code> function
to create a dataset to share between multiple replicates, it can be used
for much more, such as taking a sample from an existing dataset,
computing shared nuisance function estimators, performing
computationally-intense tasks, and so on.</li>
<li>Currently, if your simulation script uses the <code>batch</code>
function, you cannot update the simulation using the
<code>update_sim</code> (or <code>update_sim_on_cluster</code>),
function <em>unless</em> all you are doing is removing replicates. This
may be changed in the future.</li>
</ol>
</div>
<div class="section level2">
<h2 id="setting-seeds">Setting seeds<a class="anchor" aria-label="anchor" href="#setting-seeds"></a>
</h2>
<p>In statistical research, it is often desirable to have the ability to
reproduce the exact results of a simulation. Since R code often involves
stochastic (random) functions like <code>rnorm</code> or
<code>sample</code> that return different values when called multiple
times, reproducibility is not guaranteed. In a simple R script, calling
the <code>set.seed</code> function at the top of your script ensures
that the code that follows will produce the same results whenever the
script is run. However, a more nuanced strategy is needed when running
simulations. If we are running 100 replicates of the same simulation, we
typically don’t want each replicate to return identical results; rather,
we would like for each replicate to be different from one another, but
for <em>the entire set of replicates</em> to be the same when we run the
entire simulation twice in a row. Luckily, <strong>SimEngine</strong>
manages this process for you, even when simulations are being run in
parallel. <strong>SimEngine</strong> uses a single “global seed” that
changes the individual seeds for each simulation replicate; use
<code>set_config</code> to set or change this global seed:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_config.html">set_config</a></span><span class="op">(</span>seed<span class="op">=</span><span class="fl">123</span><span class="op">)</span></span></code></pre></div>
<p>If you did not set a seed with <code>set_config</code>,
<strong>SimEngine</strong> will set a random seed automatically for you
so that you can reproduce the results later if desired. To view this
seed, use the <code>vars</code> function:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_sim.html">new_sim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/vars.html">vars</a></span><span class="op">(</span><span class="va">sim</span>, <span class="st">"seed"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 287577520</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="handling-errors-and-warnings">Handling errors and warnings<a class="anchor" aria-label="anchor" href="#handling-errors-and-warnings"></a>
</h2>
<p>As with any type of programming, debugging is a necessary part of the
coding workflow. With simulations, sometimes errors occur that will
affect all simulation replicates and sometimes errors occur that only
affect some replicates. By default, when a simulation is run,
<strong>SimEngine</strong> will not stop if an error occurs; instead,
errors are logged and stored in a dataframe along with information about
the simulation replicates that resulted in those errors. Examining this
dataframe by typing <code>print(sim$errors)</code> can sometimes help to
quickly pinpoint the issue. This is demonstrated below:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_sim.html">new_sim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_config.html">set_config</a></span><span class="op">(</span>num_sim<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_levels.html">set_levels</a></span><span class="op">(</span></span>
<span>  Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    s1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mtx<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    s3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mtx<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">9</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    s2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mtx<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    s4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mtx<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">6</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_script.html">set_script</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>, mu<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, Sigma<span class="op">=</span><span class="va">L</span><span class="op">$</span><span class="va">Sigma</span><span class="op">$</span><span class="va">mtx</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x1<span class="op">=</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, x2<span class="op">=</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Done. Errors detected in 25% of simulation replicates. Warnings detected in 0% of simulation replicates.</span></span>
<span></span>
<span><span class="va">sim</span><span class="op">$</span><span class="va">errors</span></span>
<span><span class="co">#&gt;   sim_uid level_id rep_id Sigma      runtime                          message</span></span>
<span><span class="co">#&gt; 1       5        3      1    s2 0.0003933907 'Sigma' is not positive definite</span></span>
<span><span class="co">#&gt; 2       6        3      2    s2 0.0037193298 'Sigma' is not positive definite</span></span>
<span><span class="co">#&gt;                                                      call</span></span>
<span><span class="co">#&gt; 1 MASS::mvrnorm(n = 1, mu = c(0, 0), Sigma = L$Sigma$mtx)</span></span>
<span><span class="co">#&gt; 2 MASS::mvrnorm(n = 1, mu = c(0, 0), Sigma = L$Sigma$mtx)</span></span></code></pre></div>
<p>From the output above, we see that our code fails for the simulation
replicates that use the level with <code>Sigma="s2"</code> because it
uses an invalid covariance matrix. Similarly, if a simulation involves
replicates that throw warnings, all warnings are logged and stored in
the dataframe <code>sim$warnings</code>.</p>
<p>The workflow above can be useful to quickly spot errors, but it has
two main drawbacks. First, it can be frustrating to run a time-consuming
simulation involving hundreds or thousands of replicates, only to find
out at the very end that every replicate failed because of a typo. It is
often useful to stop an entire simulation after a single error has
occurred. Second, it can sometimes be difficult to determine exactly
what caused an error without making use of more advanced debugging
tools. For both of these situations, use the following configuration
option:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/set_config.html">set_config</a></span><span class="op">(</span>stop_at_error<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Setting <code>stop_at_error=TRUE</code> will stop the simulation when
it encounters any error. Furthermore, the error will be thrown by R in
the usual way, and so if you are running the simulation in RStudio, you
can make use of the built-in debugging tools to find and fix the bug.
For example, you can click “Show Traceback” to view the entire call
stack and see the function calls that led to the error, or you can click
“Rerun with debug” to active the interactive debugger, which reruns the
code and pauses execution where the error occurred so that you can
examine objects in the function’s environment. Try running the code
above in RStudio but with the <code>stop_at_error=TRUE</code>
configuration option, clicking “Rerun with debug”, and then typing
<code>print(Sigma)</code> in the console.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Avi Kenny, Charles Wolock.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
